<div class="jahresplanung-container">
  <h1>Gamification - Jahresplanung</h1>
  <table mat-table [dataSource]="tableRows" class="mat-elevation-z8">
    <ng-container matColumnDef="taskType">
      <th mat-header-cell *matHeaderCellDef> Aktivität </th>
      <td mat-cell *matCellDef="let row"> {{ row.taskTypeName }} </td>
      <td mat-footer-cell *matFooterCellDef>Summe</td>
    </ng-container>
    <ng-container matColumnDef="amount">
      <th mat-header-cell *matHeaderCellDef> Anzahl </th>
      <td mat-cell *matCellDef="let row">
        <input 
          type="number" 
          min="0" 
          [ngModel]="getPlanInput(row.id).amount" 
          (ngModelChange)="updateAmountLocal(row.id, $event)"
          (blur)="updateAmount(row)"
          style="width: 70px;" />
      </td>
      <td mat-footer-cell *matFooterCellDef></td>
    </ng-container>
    <ng-container matColumnDef="amountPerActivity">
      <th mat-header-cell *matHeaderCellDef> Menge-pro-Aktivität </th>
      <td mat-cell *matCellDef="let row">
        <input 
          type="number" 
          min="0" 
          [ngModel]="getPlanInput(row.id).amountPerActivity" 
          (ngModelChange)="updateAmountPerActivityLocal(row.id, $event)"
          (blur)="updateAmountPerActivity(row)"
          style="width: 70px;" />
      </td>
      <td mat-footer-cell *matFooterCellDef></td>
    </ng-container>
    <ng-container matColumnDef="punkteProCHF">
      <th mat-header-cell *matHeaderCellDef> Punkte/CHF </th>
      <td mat-cell *matCellDef="let row"> {{ row.points }} </td>
      <td mat-footer-cell *matFooterCellDef></td>
    </ng-container>
    <ng-container matColumnDef="maxPunkte">
      <th mat-header-cell *matHeaderCellDef> Max. Punkte </th>
      <td mat-cell *matCellDef="let row"> 
        {{ getPlanInput(row.id).amount * getPlanInput(row.id).amountPerActivity * row.points }} 
      </td>
      <td mat-footer-cell *matFooterCellDef></td>
    </ng-container>
    <ng-container matColumnDef="vereinssaldo">
      <th mat-header-cell *matHeaderCellDef> Vereins-Saldo </th>
      <td mat-cell *matCellDef="let row"> 
        @if (row.isSpende) {
          {{ getPlanInput(row.id).amount * getPlanInput(row.id).amountPerActivity * row.points / (gamificationParameter?.pointsPerCHF || 1) }}
        } @else {
          {{ (-1) * (getPlanInput(row.id).amount * getPlanInput(row.id).amountPerActivity * row.points / (gamificationParameter?.pointsPerCHF || 1)) }}
        }
      </td>
      <td mat-footer-cell *matFooterCellDef>{{ totalVereinssaldo | number:'1.2-2' }}</td>
    </ng-container>
    <ng-container matColumnDef="vereinsaldoMitVereinskostenanteil">
      <th mat-header-cell *matHeaderCellDef> Vereins-Saldo mit Vereinskostenanteil </th>
      <td mat-cell *matCellDef="let row"> 
        @if (row.isSpende) {
          {{ getPlanInput(row.id).amount * getPlanInput(row.id).amountPerActivity * row.points / (gamificationParameter?.pointsPerCHF || 1) }}
        } @else {
          {{ (-1) * (getPlanInput(row.id).amount * getPlanInput(row.id).amountPerActivity * row.points / (gamificationParameter?.pointsPerCHF || 1) * (row.clubCostShare || 0) / 100) }}
        }
      </td>
      <td mat-footer-cell *matFooterCellDef>{{ totalVereinssaldoMitVereinskostenanteil | number:'1.2-2' }}</td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    <tr mat-footer-row *matFooterRowDef="displayedColumns"></tr>
  </table>
</div>
